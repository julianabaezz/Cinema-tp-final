{"ast":null,"code":"import _asyncToGenerator from\"C:\\\\Users\\\\User\\\\Desktop\\\\Programaci\\xF3n\\\\Clases Ada\\\\proyectos\\\\TP FINAL\\\\cinemada\\\\node_modules\\\\@babel\\\\runtime\\\\helpers\\\\esm\\\\asyncToGenerator.js\";import _slicedToArray from\"C:\\\\Users\\\\User\\\\Desktop\\\\Programaci\\xF3n\\\\Clases Ada\\\\proyectos\\\\TP FINAL\\\\cinemada\\\\node_modules\\\\@babel\\\\runtime\\\\helpers\\\\esm\\\\slicedToArray.js\";import _regeneratorRuntime from\"C:\\\\Users\\\\User\\\\Desktop\\\\Programaci\\xF3n\\\\Clases Ada\\\\proyectos\\\\TP FINAL\\\\cinemada\\\\node_modules\\\\@babel\\\\runtime\\\\regenerator\\\\index.js\";import{useContext,useState}from\"react\";import{useEffect}from\"react\";import{useHistory}from\"react-router-dom\";import{UsersContext}from\"../../contexts\";import{mapToArray}from\"../../helpers\";import{api_DB}from\"../../utils\";// import {useUsers} from \"../useUsers\"\nvar useAuth=function useAuth(){// const [userSession, setUserSession] = useState<User>(\n//     JSON.parse(localStorage.getItem(\"user\")!)\n// )\nvar _useState=useState(),_useState2=_slicedToArray(_useState,2),hasUserLoggedIn=_useState2[0],setHasUserLoggedIn=_useState2[1];var _useState3=useState(localStorage.getItem(\"cinemada-token\")||undefined),_useState4=_slicedToArray(_useState3,2),tokenStorage=_useState4[0],setTokenStorage=_useState4[1];var _useContext=useContext(UsersContext),setCurrentUser=_useContext.setCurrentUser;var _useHistory=useHistory(),push=_useHistory.push;useEffect(function(){if(tokenStorage)localStorage.setItem(\"cinemada-token\",tokenStorage);// console.log(\"Estoy pasando por useAuth\");\n},[tokenStorage]);useEffect(function(){loginWithToken();},[]);var createUserToken=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(user){var newToken;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:newToken=Math.random().toString(36).substring(2);_context.prev=1;_context.next=4;return api_DB.patch(\"/users/\".concat(user.idDB,\".json\"),{sessionToken:newToken});case 4:return _context.abrupt(\"return\",newToken);case 7:_context.prev=7;_context.t0=_context[\"catch\"](1);return _context.abrupt(\"return\",null);case 10:case\"end\":return _context.stop();}}},_callee,null,[[1,7]]);}));return function createUserToken(_x){return _ref.apply(this,arguments);};}();var login=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(payload){var response,users,loggedUser,token;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;_context2.next=3;return api_DB.get(\"/users.json\");case 3:response=_context2.sent;users=mapToArray(response.data);loggedUser=users.find(function(user){return user.email===payload.email&&user.password===payload.password;});if(!loggedUser){_context2.next=13;break;}_context2.next=9;return createUserToken(loggedUser);case 9:token=_context2.sent;// return loggedUser\nif(token){// console.log(loggedUser)\nsetTokenStorage(token);setCurrentUser===null||setCurrentUser===void 0?void 0:setCurrentUser(loggedUser);setHasUserLoggedIn(true);push(\"/\");}else{setHasUserLoggedIn(false);}_context2.next=14;break;case 13:throw new Error(\"El usuario no existe\");case 14:_context2.next=19;break;case 16:_context2.prev=16;_context2.t0=_context2[\"catch\"](0);console.log(_context2.t0);case 19:case\"end\":return _context2.stop();}}},_callee2,null,[[0,16]]);}));return function login(_x2){return _ref2.apply(this,arguments);};}();var loginWithToken=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var response,users,loggedUser;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:console.log(tokenStorage);_context3.prev=1;_context3.next=4;return api_DB.get(\"/users.json\");case 4:response=_context3.sent;users=mapToArray(response.data);loggedUser=users.find(function(user){return user.sessionToken===tokenStorage;});if(loggedUser){setCurrentUser===null||setCurrentUser===void 0?void 0:setCurrentUser(loggedUser);setHasUserLoggedIn(true);}else{setHasUserLoggedIn(false);}_context3.next=13;break;case 10:_context3.prev=10;_context3.t0=_context3[\"catch\"](1);console.log(_context3.t0);case 13:case\"end\":return _context3.stop();}}},_callee3,null,[[1,10]]);}));return function loginWithToken(){return _ref3.apply(this,arguments);};}();var logout=function logout(){localStorage.removeItem(\"cinemada-token\");push(\"/login\");};return{login:login,loginWithToken:loginWithToken,logout:logout,hasUserLoggedIn:hasUserLoggedIn};};export{useAuth};","map":{"version":3,"sources":["C:/Users/User/Desktop/ProgramaciÃ³n/Clases Ada/proyectos/TP FINAL/cinemada/src/hooks/auth/index.ts"],"names":["useContext","useState","useEffect","useHistory","UsersContext","mapToArray","api_DB","useAuth","hasUserLoggedIn","setHasUserLoggedIn","localStorage","getItem","undefined","tokenStorage","setTokenStorage","setCurrentUser","push","setItem","loginWithToken","createUserToken","user","newToken","Math","random","toString","substring","patch","idDB","sessionToken","login","payload","get","response","users","data","loggedUser","find","email","password","token","Error","console","log","logout","removeItem"],"mappings":"khBAAA,OAASA,UAAT,CAAqBC,QAArB,KAAqC,OAArC,CACA,OAASC,SAAT,KAA0B,OAA1B,CACA,OAASC,UAAT,KAA2B,kBAA3B,CACA,OAASC,YAAT,KAA6B,gBAA7B,CACA,OAASC,UAAT,KAA2B,eAA3B,CAEA,OAASC,MAAT,KAAuB,aAAvB,CACA;AAGA,GAAMC,CAAAA,OAAO,CAAG,QAAVA,CAAAA,OAAU,EAAM,CAClB;AACI;AACA;AACJ,cAA8CN,QAAQ,EAAtD,wCAAOO,eAAP,eAAwBC,kBAAxB,eAEA,eAAwCR,QAAQ,CAC5CS,YAAY,CAACC,OAAb,CAAqB,gBAArB,GAA0CC,SADE,CAAhD,yCAAOC,YAAP,eAAqBC,eAArB,eAIA,gBAA2Bd,UAAU,CAACI,YAAD,CAArC,CAAQW,cAAR,aAAQA,cAAR,CACA,gBAAiBZ,UAAU,EAA3B,CAAQa,IAAR,aAAQA,IAAR,CAEAd,SAAS,CAAC,UAAM,CACZ,GAAGW,YAAH,CAAkBH,YAAY,CAACO,OAAb,CAAqB,gBAArB,CAAuCJ,YAAvC,EAClB;AACH,CAHQ,CAGN,CAACA,YAAD,CAHM,CAAT,CAKAX,SAAS,CAAC,UAAK,CACXgB,cAAc,GACjB,CAFQ,CAEN,EAFM,CAAT,CAIA,GAAMC,CAAAA,eAAe,0FAAG,iBAAOC,IAAP,+HACdC,QADc,CACHC,IAAI,CAACC,MAAL,GAAcC,QAAd,CAAuB,EAAvB,EAA2BC,SAA3B,CAAqC,CAArC,CADG,uCAGVnB,CAAAA,MAAM,CAACoB,KAAP,kBAAuBN,IAAI,CAACO,IAA5B,UAAyC,CAAEC,YAAY,CAAEP,QAAhB,CAAzC,CAHU,wCAITA,QAJS,0FAMT,IANS,sEAAH,kBAAfF,CAAAA,eAAe,4CAArB,CAUA,GAAMU,CAAAA,KAAK,2FAAG,kBAAOC,OAAP,kMAEiBxB,CAAAA,MAAM,CAACyB,GAAP,CAAW,aAAX,CAFjB,QAEAC,QAFA,gBAGAC,KAHA,CAGgB5B,UAAU,CAAC2B,QAAQ,CAACE,IAAV,CAH1B,CAIAC,UAJA,CAIaF,KAAK,CAACG,IAAN,CACf,SAAChB,IAAD,QACIA,CAAAA,IAAI,CAACiB,KAAL,GAAeP,OAAO,CAACO,KAAvB,EAAgCjB,IAAI,CAACkB,QAAL,GAAkBR,OAAO,CAACQ,QAD9D,EADe,CAJb,KASFH,UATE,kDAUkBhB,CAAAA,eAAe,CAACgB,UAAD,CAVjC,QAUII,KAVJ,gBAWF;AACA,GAAIA,KAAJ,CAAW,CACP;AACAzB,eAAe,CAACyB,KAAD,CAAf,CACAxB,cAAc,OAAd,EAAAA,cAAc,SAAd,QAAAA,cAAc,CAAGoB,UAAH,CAAd,CACA1B,kBAAkB,CAAC,IAAD,CAAlB,CACAO,IAAI,CAAC,GAAD,CAAJ,CACH,CAND,IAMO,CACHP,kBAAkB,CAAC,KAAD,CAAlB,CAEH,CArBC,qCAwBI,IAAI+B,CAAAA,KAAJ,CAAU,sBAAV,CAxBJ,8FA2BNC,OAAO,CAACC,GAAR,eA3BM,uEAAH,kBAALb,CAAAA,KAAK,8CAAX,CA+BA,GAAMX,CAAAA,cAAc,2FAAG,sKACnBuB,OAAO,CAACC,GAAR,CAAY7B,YAAZ,EADmB,wCAGQP,CAAAA,MAAM,CAACyB,GAAP,CAAW,aAAX,CAHR,QAGTC,QAHS,gBAITC,KAJS,CAIO5B,UAAU,CAAC2B,QAAQ,CAACE,IAAV,CAJjB,CAKTC,UALS,CAKIF,KAAK,CAACG,IAAN,CACf,SAAChB,IAAD,QAAUA,CAAAA,IAAI,CAACQ,YAAL,GAAsBf,YAAhC,EADe,CALJ,CASf,GAAIsB,UAAJ,CAAgB,CACZpB,cAAc,OAAd,EAAAA,cAAc,SAAd,QAAAA,cAAc,CAAGoB,UAAH,CAAd,CACA1B,kBAAkB,CAAC,IAAD,CAAlB,CACH,CAHD,IAII,CACAA,kBAAkB,CAAC,KAAD,CAAlB,CACH,CAfc,qFAiBfgC,OAAO,CAACC,GAAR,eAjBe,uEAAH,kBAAdxB,CAAAA,cAAc,2CAApB,CAqBA,GAAMyB,CAAAA,MAAM,CAAG,QAATA,CAAAA,MAAS,EAAK,CAChBjC,YAAY,CAACkC,UAAb,CAAwB,gBAAxB,EACA5B,IAAI,CAAC,QAAD,CAAJ,CACH,CAHD,CAKA,MAAO,CAAEa,KAAK,CAALA,KAAF,CAASX,cAAc,CAAdA,cAAT,CAAyByB,MAAM,CAANA,MAAzB,CAAiCnC,eAAe,CAAfA,eAAjC,CAAP,CACH,CA1FD,CA4FA,OAASD,OAAT","sourcesContent":["import { useContext, useState } from \"react\";\r\nimport { useEffect } from \"react\";\r\nimport { useHistory } from \"react-router-dom\";\r\nimport { UsersContext } from \"../../contexts\";\r\nimport { mapToArray } from \"../../helpers\";\r\nimport { LogUserType, User } from \"../../types/models\";\r\nimport { api_DB } from \"../../utils\";\r\n// import {useUsers} from \"../useUsers\"\r\n\r\n\r\nconst useAuth = () => {\r\n    // const [userSession, setUserSession] = useState<User>(\r\n        //     JSON.parse(localStorage.getItem(\"user\")!)\r\n        // )\r\n    const [hasUserLoggedIn, setHasUserLoggedIn] = useState<boolean>()\r\n\r\n    const [tokenStorage, setTokenStorage] = useState<string | undefined>(\r\n        localStorage.getItem(\"cinemada-token\") || undefined\r\n        );\r\n            \r\n    const { setCurrentUser } = useContext(UsersContext);\r\n    const { push } = useHistory();\r\n    \r\n    useEffect(() => {\r\n        if(tokenStorage)  localStorage.setItem(\"cinemada-token\", tokenStorage);\r\n        // console.log(\"Estoy pasando por useAuth\");\r\n    }, [tokenStorage]);\r\n\r\n    useEffect(() =>{\r\n        loginWithToken()\r\n    }, [])\r\n\r\n    const createUserToken = async (user: User) => {\r\n        const newToken = Math.random().toString(36).substring(2);\r\n        try {\r\n            await api_DB.patch(`/users/${user.idDB}.json`, { sessionToken: newToken });\r\n            return newToken;\r\n        } catch (err) {\r\n            return null;\r\n        }\r\n    };\r\n\r\n    const login = async (payload: LogUserType) => {\r\n        try {\r\n            const response = await api_DB.get(\"/users.json\");\r\n            const users: User[] = mapToArray(response.data);\r\n            const loggedUser = users.find(\r\n                (user) =>\r\n                    user.email === payload.email && user.password === payload.password\r\n            );\r\n\r\n            if (loggedUser) {\r\n                const token = await createUserToken(loggedUser);\r\n                // return loggedUser\r\n                if (token) {\r\n                    // console.log(loggedUser)\r\n                    setTokenStorage(token);\r\n                    setCurrentUser?.(loggedUser);\r\n                    setHasUserLoggedIn(true)\r\n                    push(\"/\");\r\n                } else {\r\n                    setHasUserLoggedIn(false)\r\n                    \r\n                }\r\n            }\r\n            else{\r\n                throw new Error(\"El usuario no existe\");\r\n            }\r\n        } catch (e) {\r\n            console.log(e);\r\n        }\r\n    };\r\n\r\n    const loginWithToken = async() => {\r\n        console.log(tokenStorage);\r\n        try {\r\n            const response = await api_DB.get(\"/users.json\");\r\n            const users: User[] = mapToArray(response.data);\r\n            const loggedUser = users.find(\r\n                (user) => user.sessionToken === tokenStorage\r\n            );\r\n\r\n            if (loggedUser) {\r\n                setCurrentUser?.(loggedUser);\r\n                setHasUserLoggedIn(true)\r\n            }\r\n            else{\r\n                setHasUserLoggedIn(false)\r\n            }\r\n        } catch (e) {\r\n            console.log(e);\r\n        }\r\n    };\r\n    \r\n    const logout = () =>{\r\n        localStorage.removeItem(\"cinemada-token\");\r\n        push(\"/login\")\r\n    }\r\n\r\n    return { login, loginWithToken, logout, hasUserLoggedIn };\r\n};\r\n\r\nexport { useAuth };\r\n"]},"metadata":{},"sourceType":"module"}